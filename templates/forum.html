{% extends 'base.html' %}

{% block title %}Forum{% endblock %}

{% block content %}
<h1>Forum</h1>

<!-- Formularz filtrowania -->
<form method="GET" action="/forum" class="filter-form">
    <div class="filter-row">
        <label for="author">Author:</label>
        <input type="text" name="author" id="author" value="{{ request.args.get('author', '') }}">

        <label for="tag">Tag:</label>
        <input type="text" name="tag" id="tag" value="{{ request.args.get('tag', '') }}">

        <label for="sort_by">Sort By:</label>
        <select name="sort_by" id="sort_by">
            <option value="created_at" {% if request.args.get('sort_by') == 'created_at' %}selected{% endif %}>Newest</option>
            <option value="likes" {% if request.args.get('sort_by') == 'likes' %}selected{% endif %}>Most Liked</option>
        </select>
    </div>
    <div class="filter-row">
        <button type="submit">Filter</button>
        <a href="/forum" class="reset-button">Reset</a>
    </div>
</form>

<!-- Formularz tworzenia nowego posta -->
{% if current_user.is_authenticated %}
<form method="POST" enctype="multipart/form-data" class="new-post-form">
    <input type="text" name="title" placeholder="Post title" required>
    <textarea name="content" placeholder="Write your post..." rows="4" required></textarea>
    <input type="text" name="tags" placeholder="Tags (comma-separated)">
    <label for="image">Upload an image:</label>
    <input type="file" name="image" id="image" accept="image/*">
    <button type="submit">Create Post</button>
</form>
{% else %}
<p>You need to <a href="/login">log in</a> to create a post.</p>
{% endif %}


<hr>

<!-- Wyświetlanie postów -->
<div class="posts">
    {% for post in posts.items %}
    <div class="post-card">
        <h2>{{ post.title }}</h2>
        {% if post.image %}
<img src="{{ url_for('static', filename=post.image) }}" alt="Post Image" class="post-image">
{% endif %}

    <p>{{ post.content }}</p>
    <p><small>Posted by {{ post.author }} on {{ post.created_at }}</small></p>
    <p>
        Tags: 
        {% for tag in post.tags.split(',') %}
        <span class="tag">{{ tag.strip() }}</span>
        {% endfor %}
    </p>

       <!-- Polubienia -->
<div class="like-section">
    <!-- Like -->
    <button class="like-button" data-post-id="{{ post.id }}">
        <img src="{{ url_for('static', filename='icons/like.png') }}" alt="Like" width="20">
    </button>

    <!-- Unlike -->
    <button class="unlike-button" data-post-id="{{ post.id }}">
        <img src="{{ url_for('static', filename='icons/unlike.png') }}" alt="Unlike" width="20">
    </button>

    <!-- Liczniki -->
    <span id="post-likes-count-{{ post.id }}">Likes: {{ post.likes_count }}</span>
    <span id="post-unlikes-count-{{ post.id }}">Unlikes: {{ post.unlikes_count }}</span>
</div>

        

<div class="comments-section">
    <h3>Comments:</h3>

    <!-- Formularz dodawania komentarza -->
    <form method="POST" action="/comment/{{ post.id }}" enctype="multipart/form-data">
        <textarea name="content" placeholder="Write a comment..." required></textarea>
        <input type="file" name="image" accept="image/*">
        <button type="submit" class="btn-comment">Comment</button>
    </form>

    <!-- Przycisk zwijania komentarzy -->
    <button class="toggle-comments-btn" data-post-id="{{ post.id }}">▼ Comments</button>

    <!-- Lista komentarzy -->
    <ul class="comments-list" id="comments-list-{{ post.id }}">
        {% for comment in post.comments.filter_by(parent_id=None).all() %}
        <li>
            <p>{{ comment.content }}</p>
            {% if comment.image %}
            <img src="{{ url_for('static', filename=comment.image) }}" alt="Comment Image" class="comment-image">
            {% endif %}
            <p><small>Posted by User {{ comment.user_id }} on {{ comment.created_at }}</small></p>

            <!-- Polubienia -->
            <button class="like-button" data-comment-id="{{ comment.id }}">
                <img src="{{ url_for('static', filename='icons/like.png') }}" alt="Like" width="20">
            </button>
            <button class="unlike-button" data-comment-id="{{ comment.id }}">
                <img src="{{ url_for('static', filename='icons/unlike.png') }}" alt="Unlike" width="20">
            </button>
            <span id="likes-count-{{ comment.id }}">Likes: {{ comment.likes_count }}</span>
            <span id="unlikes-count-{{ comment.id }}">Unlikes: {{ comment.unlikes_count }}</span>

            <!-- Odpowiedzi -->
            <button class="toggle-replies-btn" data-comment-id="{{ comment.id }}">▼ Replies</button>
            <ul class="replies" id="replies-{{ comment.id }}">
                {% for reply in comment.replies.all() %}
                <li>
                    <p>{{ reply.content }}</p>
                    {% if reply.image %}
                    <img src="{{ url_for('static', filename=reply.image) }}" alt="Reply Image" class="reply-image">
                    {% endif %}
                    <p><small>Posted by User {{ reply.user_id }} on {{ reply.created_at }}</small></p>
                </li>
                {% endfor %}
            </ul>

            <!-- Formularz dodawania odpowiedzi -->
            <form method="POST" action="/comment/reply/{{ comment.id }}" enctype="multipart/form-data">
                <textarea name="content" placeholder="Write a reply..." required></textarea>
                <input type="file" name="image" accept="image/*">
                <button type="submit" class="btn-reply">Reply</button>
            </form>
        </li>
        {% endfor %}
    </ul>
</div>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Obsługa przycisków do zwijania komentarzy
        const toggleCommentsButtons = document.querySelectorAll('.toggle-comments-btn');

        toggleCommentsButtons.forEach(button => {
            button.addEventListener('click', () => {
                const postId = button.getAttribute('data-post-id');
                const commentsList = document.getElementById(`comments-list-${postId}`);

                if (commentsList.style.display === 'none') {
                    commentsList.style.display = 'block';
                    button.textContent = '▼ Comments'; // Zmień tekst na rozwinięcie
                } else {
                    commentsList.style.display = 'none';
                    button.textContent = '► Comments'; // Zmień tekst na zwinięcie
                }
            });
        });

        // Obsługa przycisków do zwijania odpowiedzi
        const toggleRepliesButtons = document.querySelectorAll('.toggle-replies-btn');

        toggleRepliesButtons.forEach(button => {
            button.addEventListener('click', () => {
                const commentId = button.getAttribute('data-comment-id');
                const repliesSection = document.getElementById(`replies-${commentId}`);

                if (repliesSection.style.display === 'none') {
                    repliesSection.style.display = 'block';
                    button.textContent = '▼ Replies'; // Zmień tekst na rozwinięcie
                } else {
                    repliesSection.style.display = 'none';
                    button.textContent = '► Replies'; // Zmień tekst na zwinięcie
                }
            });
        });
    });
</script>

        
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                // Obsługa przycisku Like
                const likeButtons = document.querySelectorAll('.like-button');
                likeButtons.forEach(button => {
                    button.addEventListener('click', (event) => {
                        event.preventDefault(); // Zapobiega przeładowaniu strony
                        const commentId = button.getAttribute('data-comment-id');
                        fetch(`/comment/like/${commentId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        })
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById(`likes-count-${commentId}`).textContent = `Likes: ${data.likes_count}`;
                            document.getElementById(`unlikes-count-${commentId}`).textContent = `Unlikes: ${data.unlikes_count}`;
                        })
                        .catch(error => console.error('Error:', error));
                    });
                });
        
                // Obsługa przycisku Unlike
                const unlikeButtons = document.querySelectorAll('.unlike-button');
                unlikeButtons.forEach(button => {
                    button.addEventListener('click', (event) => {
                        event.preventDefault(); // Zapobiega przeładowaniu strony
                        const commentId = button.getAttribute('data-comment-id');
                        fetch(`/comment/unlike/${commentId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        })
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById(`likes-count-${commentId}`).textContent = `Likes: ${data.likes_count}`;
                            document.getElementById(`unlikes-count-${commentId}`).textContent = `Unlikes: ${data.unlikes_count}`;
                        })
                        .catch(error => console.error('Error:', error));
                    });
                });
            });
        </script>
        
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                // Obsługa przycisków Like
                const likeButtons = document.querySelectorAll('.like-button');
                likeButtons.forEach(button => {
                    button.addEventListener('click', (event) => {
                        event.preventDefault(); // Zapobiega przeładowaniu strony
                        const postId = button.getAttribute('data-post-id');
                        fetch(`/post/like/${postId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        })
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById(`post-likes-count-${postId}`).textContent = `Likes: ${data.likes_count}`;
                            document.getElementById(`post-unlikes-count-${postId}`).textContent = `Unlikes: ${data.unlikes_count}`;
                        })
                        .catch(error => console.error('Error:', error));
                    });
                });
        
                // Obsługa przycisków Unlike
                const unlikeButtons = document.querySelectorAll('.unlike-button');
                unlikeButtons.forEach(button => {
                    button.addEventListener('click', (event) => {
                        event.preventDefault(); // Zapobiega przeładowaniu strony
                        const postId = button.getAttribute('data-post-id');
                        fetch(`/post/unlike/${postId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        })
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById(`post-likes-count-${postId}`).textContent = `Likes: ${data.likes_count}`;
                            document.getElementById(`post-unlikes-count-${postId}`).textContent = `Unlikes: ${data.unlikes_count}`;
                        })
                        .catch(error => console.error('Error:', error));
                    });
                });
            });
        </script>
        

        <!-- Edycja i usuwanie (tylko autor) -->
     <!-- Edycja i usuwanie -->
     {% if post.user_id == current_user.id %}
     <a href="{{ url_for('edit_post', post_id=post.id) }}" class="btn-edit">Edit</a>
     <form method="POST" action="{{ url_for('delete_post', post_id=post.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this post?');">
         <button type="submit" class="btn-delete">Delete</button>
        </form>
        {% endif %}
    </div>
    {% endfor %}
</div>

<!-- Paginacja -->
<div class="pagination">
    {% if posts.has_prev %}
    <a href="{{ url_for('forum', page=posts.prev_num) }}">&laquo; Previous</a>
    {% endif %}
    <span>Page {{ posts.page }} of {{ posts.pages }}</span>
    {% if posts.has_next %}
    <a href="{{ url_for('forum', page=posts.next_num) }}">Next &raquo;</a>
    {% endif %}
</div>
{% endblock %}
